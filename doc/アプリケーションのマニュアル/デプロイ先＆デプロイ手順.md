# デプロイ先情報

## 本番環境
- **URL**: https://contact-book-main1-flsrse.laravel.cloud/
- **プラットフォーム**: Laravel Cloud
- **デプロイ日**: 2025年10月27日（新しい環境設定後）

## アクセス方法
1. 上記URLにアクセス
2. ログインページが表示されます
3. テストアカウント一覧（`テストアカウント一覧.md`）の認証情報を使用してログイン

## 注意事項
- この環境は新しい設定で構築されています
- 初回アクセス直後やスリープ復帰直後は、ログイン後に画面反応が出るまで約30秒かかる場合があります（コールドスタートによる起動待ち）。時間を置いてページ更新せずお待ちください。

## デプロイ手順（Laravel Cloud）

以下は Laravel Cloud へのデプロイ手順です。初回セットアップと、以降の更新デプロイに分かれます。

### 前提条件


### 初回セットアップ（プロジェクト作成〜環境準備）
1. Laravel Cloud ダッシュボードで新規プロジェクトを作成し、GitHub/GitLab のリポジトリを接続（今回はgithabから接続）
2. デプロイ対象ブランチを選択（例: `main`）
3. データベーステーブル、キャッシュテーブルのアドオンを有効化
4. リリース後コマンド（必要に応じて）
   - アプリキー生成（初回のみ）: `php artisan key:generate --force`
   - ストレージリンク: `php artisan storage:link`
   - マイグレーション: `php artisan migrate --force`
5. 「Deploy」実行で初回デプロイ

### 以降の更新デプロイ
1. 対象ブランチへ PR マージ（またはコミット）
2. Laravel Cloud が自動ビルド・デプロイ（設定により自動/手動）
3. 変更に DB マイグレーションが含まれる場合は `php artisan migrate --force` をリリース後コマンドに残しておく

### よくあるチェックポイント
- 500 エラー時: `APP_KEY` 未設定、キャッシュ破損 → `php artisan key:generate --force`、`php artisan config:clear` を確認
- アセット未反映: Vite ビルド設定・`npm run build` 実行有無、`mix-manifest.json`/`build` 出力の公開設定確認
- 画像/アップロード不可: `storage:link` 実行、`public/storage` リンクの有無、書き込み権限/永続ボリューム設定
- セッション切れやすい: `SESSION_DRIVER` とドライバ先（Redis/DB）の稼働確認
- メール送信不可: `MAIL_*` の値、ポート/暗号化方式の整合性

### セキュリティ/パフォーマンスの推奨
- `APP_DEBUG=false` を徹底
- 不要な `devDependencies` は本番に含めない
- `opcache`/`config:cache`/`route:cache` の有効化

### ビルド設定（詳細）
- PHP 依存解決:
  - `composer install --no-dev --prefer-dist --optimize-autoloader`
- Laravel 最適化（本番）:
  - `php artisan config:cache && php artisan route:cache && php artisan view:cache`
- フロントエンド資産（必要な場合）:
  - `npm ci && npm run build`
  - Vite の出力先（`public/build`）が公開されることを確認
- バージョン指定（推奨）:
  - PHP/Node のバージョンはプラットフォーム設定で固定（例: PHP 8.2/8.3, Node 18/20）

### 環境変数の設定（例）
- アプリ基本:
  - `APP_ENV=production`
  - `APP_DEBUG=false`
  - `APP_URL=https://<本番ドメイン>`
- DB 接続:
  - `DB_CONNECTION=mysql`
  - `DB_HOST` / `DB_PORT` / `DB_DATABASE` / `DB_USERNAME` / `DB_PASSWORD`
- キャッシュ/セッション/キュー:
  - `CACHE_DRIVER=redis|file`
  - `SESSION_DRIVER=redis|database|file`
  - `QUEUE_CONNECTION=redis|database|sync`
- メール送信（必要時）:
  - `MAIL_MAILER=smtp`
  - `MAIL_HOST` / `MAIL_PORT` / `MAIL_USERNAME` / `MAIL_PASSWORD` / `MAIL_ENCRYPTION=tls|ssl`
  - `MAIL_FROM_ADDRESS` / `MAIL_FROM_NAME`
- ストレージ:
  - `FILESYSTEM_DISK=public|s3`
  - （S3 の場合）`AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY` / `AWS_DEFAULT_REGION` / `AWS_BUCKET`

### ロールバック（デプロイの巻き戻し）
- 手順（UI 例）:
  - プロジェクトのリリース履歴を開く → 直前の安定版を選択 → Rollback 実行
- DB スキーマの後戻しが必要な場合:
  - 直近のリリース後コマンドに `php artisan migrate:rollback --step=1` 相当を用意するか、メンテ手順として個別実行
  - データ損失に注意（本番では基本は前方互換の `migrate` のみを推奨）
- 参考:
  - ロールバック後は `config:cache` などのキャッシュを再生成して整合性を担保

### キュー / スケジューラ（運用）
- キュー（ジョブ処理）:
  - 接続: `QUEUE_CONNECTION=redis|database`
  - ワーカー: プラットフォームのワーカー機能を有効化し、`php artisan queue:work --sleep=3 --tries=3` などを常駐
  - Horizon を使う場合はダッシュボード保護（認可）を設定
- スケジューラ（定期実行）:
  - `php artisan schedule:run` を 1分毎で実行するスケジューラ/cron 設定を有効化
  - ジョブの実行結果はログ/監視に連携

