# 学籍番号ベース認証への移行計画

## 📋 概要

現在のメールアドレスベースの認証から、**学籍番号ベースの認証**に移行します。

### 背景・理由
- 想定ユーザーが中学生であり、全員にメールアドレスを付与するのは現実的ではない
- 学籍番号ベースの方が学校運営の実態に即している
- パスワードリセット機能（メール送信）が不要になり、運用がシンプルになる

---

## 🎯 要件定義

### 1. ログイン方式

| 項目 | 内容 |
|------|------|
| **ログインID** | 学籍番号（7桁の数字） |
| **初期パスワード** | `学籍番号 + pw`<br>例：学籍番号が `2024001` なら初期パスワードは `2024001pw` |
| **ログイン後** | 初回ログイン時は強制的にパスワード変更画面へ遷移 |
| **パスワード要件** | ・8文字以上<br>・半角英数字を含む |

### 2. 学籍番号フォーマット

#### 生徒（student）
- **フォーマット**: `YYYY###` （7桁）
  - `YYYY`: 入学年度（4桁）
  - `###`: 連番（3桁、001から開始）
- **例**: 
  - `2024001` （2024年度入学、1番）
  - `2024002` （2024年度入学、2番）
  - `2025050` （2025年度入学、50番）

#### 先生（teacher）
- **フォーマット**: `1234###` （7桁）
  - 固定プレフィックス: `1234`
  - `###`: 連番（3桁、001から開始）
- **例**: 
  - `1234001` （先生1番）
  - `1234002` （先生2番）
  - `1234050` （先生50番）

#### 管理者（admin）
- **フォーマット**: `9875###` （7桁）
  - 固定プレフィックス: `9875`
  - `###`: 連番（3桁、001から開始）
- **例**: 
  - `9875001` （管理者1番）
  - `9875002` （管理者2番）

### 3. ロール判定ルール

学籍番号のプレフィックスでロールを自動判定：

```php
if (str_starts_with($student_number, '1234')) {
    $role = 'teacher';
} elseif (str_starts_with($student_number, '9875')) {
    $role = 'admin';
} else {
    $role = 'student';
}
```

---

## 🔄 運用フロー

### 新入生入学時
1. **管理者がCSV一括登録**
   - 学籍番号を指定（例：2024001〜2024100）
   - システムが初期パスワードを自動生成（`学籍番号 + pw`）
2. **「学籍番号・初期パスワード一覧」を出力**
   - PDF形式でダウンロード
   - 印刷して担任に配布
3. **担任が生徒に配布**
   - 入学式または最初のホームルームで配布
   - 口頭またはプリントで以下を説明：
     - 学籍番号：`2024001`
     - 初期パスワード：`2024001pw`
     - 初回ログイン時に必ずパスワードを変更すること

### 初回ログイン時
1. **生徒がログイン**
   - 学籍番号：`2024001`
   - 初期パスワード：`2024001pw`
2. **自動的にパスワード変更画面へ遷移**
   - 「初回ログインです。パスワードを変更してください。」と表示
   - 現在のパスワード（初期パスワード）を入力
   - 新しいパスワードを入力（2回）
3. **パスワード変更完了**
   - `is_first_login` フラグが `false` に更新
   - 次回以降は通常のログイン画面へ

### パスワード紛失時
1. **生徒が担任に報告**
   - 「パスワードを忘れました」
2. **担任がパスワードをリセット**
   - 担任画面から「パスワードリセット」ボタンをクリック
   - 該当生徒を選択
   - 「リセット」を実行
   - システムが初期パスワードに戻す（`学籍番号 + pw`）
   - `is_first_login` フラグが `true` に戻る
3. **担任が生徒に初期パスワードを伝える**
   - 口頭で伝える（例：「初期パスワードは学籍番号 + pw です」）
   - または紙に書いて渡す
4. **生徒が再度初回ログイン処理**
   - 初期パスワードでログイン
   - パスワード変更画面で新しいパスワードに変更

---

## 🛠️ 実装内容

### フェーズ1：データベース変更 ⏱️ 30分

#### 1.1 マイグレーション作成
```bash
php artisan make:migration add_student_number_to_users_table
```

#### 1.2 追加するカラム
| カラム名 | 型 | NULL | デフォルト | 説明 |
|----------|-----|------|-----------|------|
| `student_number` | varchar(7) | NO | - | 学籍番号（ユニーク） |
| `is_first_login` | boolean | NO | true | 初回ログインフラグ |

#### 1.3 マイグレーション内容
```php
Schema::table('users', function (Blueprint $table) {
    $table->string('student_number', 7)->unique()->after('id');
    $table->boolean('is_first_login')->default(true)->after('password');
});
```

#### 1.4 既存データの移行
- 既存ユーザーに仮の学籍番号を付与
- 生徒：`2024001`〜
- 先生：`1234001`〜
- 管理者：`9875001`〜

#### 1.5 シーダー更新
- `DatabaseSeeder.php` を更新
- 学籍番号形式で初期ユーザーを作成

---

### フェーズ2：認証変更 ⏱️ 1時間

#### 2.1 ログイン画面変更
- **ファイル**: `resources/views/auth/login.blade.php`
- **変更内容**:
  - 「メールアドレス」→「学籍番号」に変更
  - `email` フィールド → `student_number` フィールドに変更
  - プレースホルダー：「例：2024001」
  - パスワードリセットリンクを削除

#### 2.2 認証ロジック変更
- **ファイル**: `app/Http/Controllers/Auth/LoginController.php`
- **変更内容**:
  - 認証のキーを `email` から `student_number` に変更
  - バリデーション：7桁の数字のみ

```php
public function username()
{
    return 'student_number';
}

protected function validateLogin(Request $request)
{
    $request->validate([
        'student_number' => 'required|string|size:7|regex:/^[0-9]+$/',
        'password' => 'required|string',
    ], [
        'student_number.required' => '学籍番号を入力してください。',
        'student_number.size' => '学籍番号は7桁で入力してください。',
        'student_number.regex' => '学籍番号は半角数字のみで入力してください。',
    ]);
}
```

#### 2.3 パスワードリセット機能の削除
- パスワードリセットリンクを削除
- パスワードリセット用のルート・コントローラー・ビューを削除または無効化

---

### フェーズ3：初回ログイン機能 ⏱️ 1時間

#### 3.1 ミドルウェア作成
```bash
php artisan make:middleware CheckFirstLogin
```

**ファイル**: `app/Http/Middleware/CheckFirstLogin.php`

```php
public function handle(Request $request, Closure $next)
{
    if (Auth::check() && Auth::user()->is_first_login) {
        // パスワード変更画面へ強制リダイレクト
        if (!$request->routeIs('password.change', 'password.update')) {
            return redirect()->route('password.change');
        }
    }
    return $next($request);
}
```

#### 3.2 パスワード変更画面作成
**ファイル**: `resources/views/auth/passwords/change.blade.php`

- 現在のパスワード（初期パスワード）を入力
- 新しいパスワードを入力（2回）
- 「パスワードを変更」ボタン

#### 3.3 パスワード変更処理
**コントローラー**: `app/Http/Controllers/Auth/PasswordChangeController.php`

```php
public function update(Request $request)
{
    $request->validate([
        'current_password' => 'required|string',
        'new_password' => 'required|string|min:8|confirmed|regex:/^(?=.*[a-zA-Z])(?=.*[0-9])/',
    ], [
        'new_password.min' => 'パスワードは8文字以上で入力してください。',
        'new_password.regex' => 'パスワードは半角英数字を含む必要があります。',
        'new_password.confirmed' => 'パスワード確認が一致しません。',
    ]);

    // 現在のパスワードを確認
    if (!Hash::check($request->current_password, Auth::user()->password)) {
        return back()->withErrors(['current_password' => '現在のパスワードが正しくありません。']);
    }

    // パスワードを更新
    Auth::user()->update([
        'password' => Hash::make($request->new_password),
        'is_first_login' => false,
    ]);

    return redirect()->route('home')->with('status', 'パスワードを変更しました。');
}
```

#### 3.4 ルート追加
```php
Route::middleware('auth')->group(function () {
    Route::get('/password/change', [PasswordChangeController::class, 'show'])->name('password.change');
    Route::post('/password/change', [PasswordChangeController::class, 'update'])->name('password.update');
});
```

---

### フェーズ4：ユーザー管理機能更新 ⏱️ 1.5時間

#### 4.1 ユーザー作成画面の変更
**ファイル**: `resources/views/admin/users/create.blade.php`

- 「メールアドレス」フィールドを削除
- 「学籍番号」フィールドを追加
- ロール選択により学籍番号の例を表示：
  - 生徒：「例：2024001」
  - 先生：「例：1234001」
  - 管理者：「例：9875001」

#### 4.2 ユーザー作成処理の変更
**ファイル**: `app/Http/Controllers/Admin/UserController.php`

```php
public function store(Request $request)
{
    $request->validate([
        'student_number' => 'required|string|size:7|unique:users,student_number|regex:/^[0-9]+$/',
        'name' => 'required|string|max:255',
        'role' => 'required|in:student,teacher,admin',
    ]);

    // ロール判定（プレフィックスで検証）
    $studentNumber = $request->student_number;
    $expectedRole = $this->getRoleFromStudentNumber($studentNumber);
    
    if ($expectedRole !== $request->role) {
        return back()->withErrors([
            'student_number' => "学籍番号のプレフィックスが{$request->role}のフォーマットと一致しません。"
        ])->withInput();
    }

    // 初期パスワード生成
    $initialPassword = $studentNumber . 'pw';

    User::create([
        'student_number' => $studentNumber,
        'name' => $request->name,
        'email' => $studentNumber . '@dummy.local', // ダミー（ユニーク制約のため）
        'role' => $request->role,
        'password' => Hash::make($initialPassword),
        'is_first_login' => true,
    ]);

    return redirect()->route('admin.users.index')->with('status', 'ユーザーを作成しました。');
}

private function getRoleFromStudentNumber($studentNumber)
{
    if (str_starts_with($studentNumber, '1234')) {
        return 'teacher';
    } elseif (str_starts_with($studentNumber, '9875')) {
        return 'admin';
    } else {
        return 'student';
    }
}
```

#### 4.3 CSV一括登録の更新
**ファイル**: `app/Http/Controllers/Admin/UserController.php`

- CSVフォーマットを変更：`学籍番号,氏名,ロール`
- メールアドレスカラムを削除
- 初期パスワードを自動生成

#### 4.4 担任によるパスワードリセット機能
**新規ファイル**: `app/Http/Controllers/Teacher/PasswordResetController.php`

```php
public function reset($studentId)
{
    // 担当クラスの生徒かチェック
    $studentIds = HomeroomAssignment::getStudentIdsForTeacher(Auth::id());
    
    if (!in_array($studentId, $studentIds->toArray())) {
        abort(403, '担当クラスの生徒ではありません。');
    }

    $student = User::findOrFail($studentId);
    
    // 初期パスワードにリセット
    $initialPassword = $student->student_number . 'pw';
    $student->update([
        'password' => Hash::make($initialPassword),
        'is_first_login' => true,
    ]);

    return back()->with('status', "{$student->name} のパスワードをリセットしました。初期パスワード: {$initialPassword}");
}
```

#### 4.5 担任画面にリセットボタン追加
**ファイル**: `resources/views/teacher/students/index.blade.php`

各生徒の行に「パスワードリセット」ボタンを追加

```html
<a href="{{ route('teacher.password.reset', $student->id) }}" 
   class="btn btn-sm btn-warning"
   onclick="return confirm('{{ $student->name }} のパスワードを初期パスワードにリセットしますか？')">
    <i class="fas fa-key"></i> PWリセット
</a>
```

#### 4.6 「学籍番号・初期パスワード一覧」PDF出力（オプション）
- CSV登録後に「初期パスワード一覧をダウンロード」ボタンを表示
- PDFまたはCSVで出力
- 内容：学籍番号、氏名、初期パスワード

---

### フェーズ5：テストと調整 ⏱️ 1時間

#### 5.1 テスト項目

**生徒ログイン**
- [ ] 学籍番号 + 初期パスワードでログインできる
- [ ] 初回ログイン時にパスワード変更画面が表示される
- [ ] パスワード変更後、次回から通常ログインできる
- [ ] 初期パスワードでは再ログインできない

**担任パスワードリセット**
- [ ] 担当クラスの生徒のパスワードをリセットできる
- [ ] 担当外の生徒のパスワードはリセットできない（403エラー）
- [ ] リセット後、生徒が初期パスワードでログインできる
- [ ] リセット後、再度パスワード変更画面が表示される

**管理者ユーザー作成**
- [ ] 学籍番号形式でユーザーを作成できる
- [ ] 学籍番号のプレフィックスとロールが一致しないとエラー
- [ ] 重複する学籍番号は登録できない

**CSV一括登録**
- [ ] 新しいCSVフォーマットで一括登録できる
- [ ] 初期パスワード一覧をダウンロードできる

#### 5.2 調整項目
- エラーメッセージの日本語化
- UI/UXの改善（プレースホルダー、ヘルプテキスト）
- バリデーションルールの最終確認

---

## 📊 影響範囲

### 変更が必要なファイル

#### データベース
- `database/migrations/XXXX_add_student_number_to_users_table.php` （新規）
- `database/seeders/DatabaseSeeder.php`
- `database/seeders/InternshipTestSeeder.php`

#### 認証関連
- `resources/views/auth/login.blade.php`
- `app/Http/Controllers/Auth/LoginController.php`
- `app/Http/Middleware/CheckFirstLogin.php` （新規）
- `resources/views/auth/passwords/change.blade.php` （新規）
- `app/Http/Controllers/Auth/PasswordChangeController.php` （新規）

#### ユーザー管理
- `resources/views/admin/users/index.blade.php`
- `resources/views/admin/users/create.blade.php`
- `resources/views/admin/users/edit.blade.php`
- `app/Http/Controllers/Admin/UserController.php`
- `app/Services/UserService.php`

#### 担任機能
- `resources/views/teacher/students/index.blade.php`
- `app/Http/Controllers/Teacher/PasswordResetController.php` （新規）

#### ルート
- `routes/web.php`

#### モデル
- `app/Models/User.php`

### 削除または無効化するファイル
- `resources/views/auth/passwords/email.blade.php` （パスワードリセット申請画面）
- `resources/views/auth/passwords/reset.blade.php` （パスワードリセット実行画面）
- `app/Http/Controllers/Auth/ForgotPasswordController.php`
- `app/Http/Controllers/Auth/ResetPasswordController.php`

---

## ⏱️ 総作業時間の見積もり

| フェーズ | 作業内容 | 所要時間 |
|---------|---------|---------|
| **1** | データベース変更 | 30分 |
| **2** | 認証変更 | 1時間 |
| **3** | 初回ログイン機能 | 1時間 |
| **4** | ユーザー管理機能更新 | 1.5時間 |
| **5** | テストと調整 | 1時間 |
| **合計** | | **約5時間** |

---

## 📝 補足事項

### セキュリティ考慮事項
1. **初期パスワードの安全性**
   - 初期パスワード（`学籍番号 + pw`）は推測可能
   - **対策**: 初回ログイン時に強制的にパスワード変更
   - **対策**: パスワード要件を厳格化（8文字以上、英数字必須）

2. **学籍番号の管理**
   - 学籍番号は個人情報として扱う
   - 不要な画面では表示しない（名前のみ表示）

3. **パスワードリセット権限**
   - 担任は担当クラスの生徒のみリセット可能
   - 管理者は全ユーザーをリセット可能

### 運用上の注意点
1. **年度更新時**
   - 新年度開始時に新入生の学籍番号を付与
   - 例：2025年度入学生は `2025001` から開始

2. **転入生対応**
   - 年度途中の転入生は、その年度の最後の番号+1を付与
   - 例：2024年度で最後が `2024100` なら転入生は `2024101`

3. **先生・管理者の番号管理**
   - 先生: `1234001` から順番に付与
   - 管理者: `9875001` から順番に付与
   - 退職者の番号は再利用しない（欠番とする）

4. **初期パスワード一覧の管理**
   - 印刷した一覧は担任が厳重に管理
   - 配布後は速やかにシュレッダー処分
   - PDFは暗号化して保存

---

## 🚀 実装開始の判断基準

以下の確認が完了したら実装を開始：
- [ ] 学籍番号のフォーマット確認（7桁でOK）
- [ ] ロール別のプレフィックス確認（生徒：YYYY###、先生：1234###、管理者：9875###）
- [ ] 初期パスワード方式確認（`学籍番号 + pw`）
- [ ] 運用フロー確認（入学時配布、担任がリセット）
- [ ] セキュリティポリシー確認（初回強制変更、パスワード要件）

---

## 📌 次のステップ

1. **このドキュメントの内容を確認**
2. **不明点や変更点があれば修正**
3. **実装開始の承認**
4. **フェーズ1から順次実装**

---

**作成日**: 2025-10-30  
**最終更新**: 2025-10-30  
**ステータス**: 📝 計画中（実装前）

