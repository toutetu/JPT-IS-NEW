# 包括的テストケース

## 概要
ContactBook アプリケーションの全機能を網羅したテストケースです。
各ロール（生徒・担任・管理者）での導線を完全にテストできます。

---

## 自動テスト（推奨）

### 自動テストの概要
手動テストを自動化し、効率的で信頼性の高いテスト実行を実現します。
全機能を網羅した50+のテストケースが自動実行されます。

### 自動テストの実行方法

#### 1. 全テストの実行
```bash
# 全機能テストを実行
php artisan test --testsuite=Feature

# 詳細出力付きで実行
php artisan test --testsuite=Feature --verbose
```

#### 2. 個別テストの実行
```bash
# 生徒機能のテスト
php artisan test tests/Feature/StudentTest.php

# 担任機能のテスト
php artisan test tests/Feature/TeacherTest.php

# 管理者機能のテスト
php artisan test tests/Feature/AdminTest.php

# 統合テスト
php artisan test tests/Feature/IntegrationTest.php
```

#### 3. 自動実行スクリプトの使用

##### Linux/Mac環境
```bash
# 実行権限を付与
chmod +x run_tests.sh

# 自動テストを実行
./run_tests.sh
```

##### Windows環境
```cmd
# 自動テストを実行
run_tests.bat
```

### 自動テストの内容

#### 生徒機能のテスト（StudentTest.php）
- **ログイン・リダイレクト**: 自動的にマイ連絡帳画面に遷移
- **マイ連絡帳一覧**: 提出履歴の表示・ページネーション
- **提出カレンダー**: カレンダー表示・提出状況の可視化
- **新規提出**: フォーム表示・提出処理・バリデーション
- **詳細表示**: 提出内容の確認・編集機能
- **修正機能**: 未読時の修正・既読時の制限
- **未提出生徒**: 空データの表示・初回提出

#### 担任機能のテスト（TeacherTest.php）
- **提出状況ダッシュボード**: 統計表示・日付フィルタ
- **連絡帳詳細**: 詳細表示・既読処理・視覚的改善
- **生徒別過去記録**: 担当クラス管理・個別記録確認
- **期間指定フィルタ**: 日付範囲での絞り込み
- **権限制御**: 担当外クラスへのアクセス制御
- **既読・未読管理**: 状態の変更・視覚的表示

#### 管理者機能のテスト（AdminTest.php）
- **ユーザー管理**: 一覧表示・新規作成・重複チェック
- **在籍割当**: クラス割当変更・データ整合性
- **担任割当**: 担当クラス変更・割当情報表示
- **権限制御**: 管理者以外のアクセス制御
- **データ表示**: 割当情報の一覧表示

#### 統合テスト（IntegrationTest.php）
- **完全フロー**: 生徒提出→担任確認→既読処理
- **管理フロー**: ユーザー作成→割当→確認
- **UI改善確認**: ページネーション・フォーム・視覚的改善
- **カレンダー機能**: 提出状況の可視化
- **エラーハンドリング**: 重複・権限・バリデーション

### 自動テストの特徴
- **自動データ準備**: テスト用データの自動作成
- **データベースリセット**: 各テストの独立性確保
- **包括的カバレッジ**: 全機能・全ロールのテスト
- **UI改善確認**: 実装した改善点の自動検証
- **エラーハンドリング**: 異常系のテストも含む

### 期待される結果
```
PASS  Tests\Feature\StudentTest
PASS  Tests\Feature\TeacherTest  
PASS  Tests\Feature\AdminTest
PASS  Tests\Feature\IntegrationTest

Tests:  50+ passed
Time:   2-3s
```

### トラブルシューティング
```bash
# データベース接続エラーの場合
php artisan config:clear
php artisan migrate:fresh

# テストデータの不整合の場合
php artisan migrate:fresh --seed --class=InternshipTestSeeder

# キャッシュの問題の場合
php artisan optimize:clear
```

### 自動テストの詳細仕様

#### テストデータの準備
- **管理者**: admin@example.com
- **担任**: teacher1@example.com (田中先生)
- **生徒**: student001@example.com (山田太郎), student004@example.com (小林未提出)
- **学年・クラス**: 1年A組の設定
- **在籍・担任割当**: 自動設定
- **過去データ**: 山田太郎の提出履歴

#### テスト実行環境
- **データベース**: SQLite（テスト用）
- **キャッシュ**: 自動クリア
- **セッション**: 独立実行
- **ファイル**: 一時的なテストファイル

#### テスト結果の解釈
- **PASS**: テスト成功
- **FAIL**: テスト失敗（要調査）
- **SKIP**: テストスキップ
- **ERROR**: 実行エラー（要修正）

#### 継続的インテグレーション
```yaml
# GitHub Actions での自動実行例
name: Automated Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
      - name: Install dependencies
        run: composer install
      - name: Run tests
        run: php artisan test --testsuite=Feature
```

#### パフォーマンステスト
- **実行時間**: 2-3秒（全テスト）
- **メモリ使用量**: 最小限
- **データベース**: 高速リセット
- **並列実行**: 可能（要設定）

#### カバレッジレポート
```bash
# カバレッジレポートの生成
php artisan test --coverage

# HTMLレポートの生成
php artisan test --coverage-html coverage/
```

### 自動テストの利点
- **効率性**: 手動テストの自動化により時間短縮
- **信頼性**: 一貫したテスト実行で人的ミスを排除
- **迅速性**: 短時間での全機能テスト
- **品質保証**: 継続的な品質チェック
- **開発支援**: リグレッションの早期発見
- **ドキュメント**: テストコードが仕様書の役割

### 手動テストとの使い分け
- **自動テスト**: 基本機能・回帰テスト・CI/CD
- **手動テスト**: UI/UX・ユーザビリティ・探索的テスト
- **組み合わせ**: 自動テストで基本品質を確保、手動テストでユーザー体験を検証

---

## 手動テストケース

### テストケース1: 生徒の導線テスト

### テスト対象アカウント
- **完璧な生徒**: `student001@example.com` (山田太郎)
- **未提出の生徒**: `student004@example.com` (小林未提出)

### 1.1 完璧な生徒での導線テスト

#### ステップ1: ログイン
1. `http://localhost:8000` にアクセス
2. `student001@example.com` / `Passw0rd!` でログイン
3. **確認**: 自動的にマイ連絡帳画面にリダイレクトされる

#### ステップ2: マイ連絡帳一覧の確認
1. マイ連絡帳画面で過去の提出履歴を確認
2. **確認項目**:
   - 提出済みの記録が多数表示される
   - 体調・メンタルスコアが表示される
   - 既読/未読の状態が表示される
   - ページネーションが正常に動作する（「＞」「＜」文字が表示されない）

#### ステップ3: 提出カレンダーの確認
1. ナビゲーションの「提出カレンダー」をクリック
2. **確認項目**:
   - 月間カレンダーが表示される
   - 提出済みの日に「済」マーク（赤い○で囲まれた「済」）が表示される
   - 前月・次月のナビゲーションが動作する
   - 凡例が正しく表示される

#### ステップ4: 新規提出の実行
1. 「新規提出」ボタンをクリック
2. **確認項目**:
   - 対象日が前登校日に自動設定される
   - 体調・メンタルスコアの初期値が3に設定される
   - ラジオボタン形式で「悪い」← 1 2 3 4 5 →「良い」が表示される
   - 体調は青色、メンタルは緑色で表示される
3. 以下の内容で提出:
   - 体調: 4
   - メンタル: 3
   - 本文: 「今日は体調が良く、授業も集中して取り組めました。」
4. 「提出する」ボタンをクリック
5. **確認**: 「提出しました。」メッセージが表示される

#### ステップ5: 提出内容の確認
1. マイ連絡帳一覧で新しく提出した記録を確認
2. 「詳細」ボタンをクリック
3. **確認項目**:
   - 提出内容が正しく表示される
   - 体調4、メンタル3、本文が表示される
   - 状態が「未読」と表示される
   - 「修正する」ボタンが表示される

#### ステップ6: 提出内容の修正
1. 「修正する」ボタンをクリック
2. **確認項目**:
   - 編集画面で既存の値が正しく表示される
   - ラジオボタン形式で選択状態が保持される
3. 内容を修正:
   - 体調: 5
   - メンタル: 4
   - 本文: 「修正: 今日はとても調子が良く、充実した一日でした。」
4. 「保存する」ボタンをクリック
5. **確認**: 「修正して保存しました。」メッセージが表示される

#### ステップ7: 修正後の確認
1. 詳細画面で修正内容を確認
2. **確認**: 修正された内容が正しく表示される

### 1.2 未提出の生徒での導線テスト

#### ステップ1: ログイン
1. `student004@example.com` / `Passw0rd!` でログイン
2. **確認**: 自動的にマイ連絡帳画面にリダイレクトされる

#### ステップ2: 空のマイ連絡帳の確認
1. マイ連絡帳一覧を確認
2. **確認項目**:
   - 「まだ提出がありません。」と表示される
   - 新規提出ボタンが表示される

#### ステップ3: 空の提出カレンダーの確認
1. 「提出カレンダー」をクリック
2. **確認項目**:
   - カレンダーに「済」マークが一切表示されない
   - 全ての日付が空白状態

#### ステップ4: 初回提出の実行
1. 「新規提出」ボタンをクリック
2. 初回提出として以下を入力:
   - 体調: 3
   - メンタル: 3
   - 本文: 「初回提出です。よろしくお願いします。」
3. 「提出する」ボタンをクリック
4. **確認**: 「提出しました。」メッセージが表示される

#### ステップ5: 初回提出後の確認
1. マイ連絡帳一覧で提出記録を確認
2. 提出カレンダーで「済」マークを確認
3. **確認**: 初回提出が正しく記録される

---

## テストケース2: 担任の導線テスト

### テスト対象アカウント
- **1年A組担任**: `teacher1@example.com` (田中先生)

### 2.1 提出状況ダッシュボードのテスト

#### ステップ1: ログイン
1. `teacher1@example.com` / `Passw0rd!` でログイン
2. **確認**: 自動的に提出一覧（担任）画面にリダイレクトされる

#### ステップ2: 今日の提出状況確認
1. 提出状況ダッシュボードを確認
2. **確認項目**:
   - 対象生徒数が表示される
   - 提出済・未提出・未読の統計が表示される
   - 未提出者一覧が表示される
   - 提出一覧が表示される

#### ステップ3: 日付フィルタのテスト
1. 対象日を過去の日付（例: 2025-10-20）に変更
2. 「表示」ボタンをクリック
3. **確認項目**:
   - 過去の提出データが表示される
   - 統計情報が更新される
   - 提出済みの記録に「👍 ✓ 既読」マークが表示される

#### ステップ4: 連絡帳詳細の確認
1. 提出済みの記録の「詳細」をクリック
2. **確認項目**:
   - 詳細画面が表示される
   - ヘッダーに「👍 ✓ 既読」バッジが表示される
   - カード全体が緑色のボーダーで囲まれる
   - 体調・メンタル・本文が表示される
   - 既読日時が表示される

#### ステップ5: 未読記録の既読処理
1. 未読の記録の「詳細」をクリック
2. **確認項目**:
   - 状態が「未読」と表示される
   - 「この記録を既読にする」ボタンが表示される
3. 「この記録を既読にする」ボタンをクリック
4. **確認**: 既読処理が実行され、状態が「👍 ✓ 既読」に変更される

### 2.2 生徒別過去記録のテスト

#### ステップ1: 生徒別過去記録画面への移動
1. ナビゲーションの「生徒別過去記録」をクリック
2. **確認項目**:
   - 担当クラス（1年A組）の生徒一覧が表示される
   - 各生徒の基本情報（名前、学年、クラス、メール）が表示される
   - 「過去記録を確認」ボタンが表示される

#### ステップ2: 特定生徒の過去記録確認
1. 山田太郎の「過去記録を確認」をクリック
2. **確認項目**:
   - 生徒の基本情報が表示される
   - 期間指定フィルタが表示される
   - 過去の連絡帳記録が表示される
   - 体調・メンタルスコアの色分け表示
   - 各記録の詳細表示・既読処理ボタン

#### ステップ3: 期間指定フィルタのテスト
1. 開始日・終了日を指定
2. 「表示」ボタンをクリック
3. **確認**: 指定期間の記録のみが表示される

#### ステップ4: 個別記録の詳細確認
1. 任意の記録の「詳細」をクリック
2. **確認項目**:
   - 記録の詳細が表示される
   - 既読・未読の状態が表示される
   - 既読処理ボタンが表示される

---

## テストケース3: 管理者の導線テスト

### テスト対象アカウント
- **管理者**: `admin@example.com` (システム管理者)

### 3.1 ユーザー管理のテスト

#### ステップ1: ログイン
1. `admin@example.com` / `Passw0rd!` でログイン
2. **確認**: 自動的にユーザー管理画面にリダイレクトされる

#### ステップ2: ユーザー一覧の確認
1. ユーザー一覧を確認
2. **確認項目**:
   - 全ユーザー（管理者・担任・生徒）が表示される
   - 各ユーザーの基本情報（ID、名前、メール、ロール）が表示される
   - 割り当てクラス情報が表示される
   - ページネーションが正常に動作する（「＞」「＜」文字が表示されない）

#### ステップ3: 新規ユーザー作成
1. 「新規ユーザー作成」ボタンをクリック
2. **確認項目**:
   - 新規ユーザー作成フォームが表示される
   - 名前・メール・ロール・パスワードの入力フィールドが表示される
   - ロール選択でstudent/teacher/adminが選択可能
3. 以下の内容で新規ユーザーを作成:
   - 名前: テスト生徒
   - メール: test@example.com
   - ロール: student
   - パスワード: TestPass123!
4. 「作成」ボタンをクリック
5. **確認**: 「ユーザーを作成しました。」メッセージが表示される

#### ステップ4: 作成後の確認
1. ユーザー一覧で新規作成したユーザーを確認
2. **確認**: 新規ユーザーが一覧に追加されている

### 3.2 在籍割当のテスト

#### ステップ1: 在籍割当フォームへの移動
1. 生徒の「在籍を変更」ボタンをクリック
2. **確認項目**:
   - 在籍割当フォームが表示される
   - 生徒情報が自動入力される
   - 現在の在籍クラスが表示される
   - クラス選択ドロップダウンが表示される

#### ステップ2: 在籍クラスの変更
1. 異なるクラスを選択
2. 「割当を実行」ボタンをクリック
3. **確認**: 在籍割当が実行される

#### ステップ3: 変更後の確認
1. ユーザー一覧に戻る
2. **確認**: 割り当てクラスが更新されている

### 3.3 担任割当のテスト

#### ステップ1: 担任割当フォームへの移動
1. 担任の「担任割当を変更」ボタンをクリック
2. **確認項目**:
   - 担任割当フォームが表示される
   - 担任情報が自動入力される
   - 現在の担当クラスが表示される
   - クラス選択ドロップダウンが表示される

#### ステップ2: 担当クラスの変更
1. 異なるクラスを選択
2. 「割当を実行」ボタンをクリック
3. **確認**: 担任割当が実行される

#### ステップ3: 変更後の確認
1. ユーザー一覧に戻る
2. **確認**: 割り当てクラスが更新されている

---

## テスト実行手順

### 1. データベース初期化
```bash
php artisan migrate:fresh --seed --class=InternshipTestSeeder
```

### 2. アプリケーション起動
```bash
php artisan serve
```

### 3. テスト実行
1. 上記のテストケースを順番に実行
2. 各ステップで確認項目をチェック
3. エラーが発生した場合は詳細を記録

---

## 期待される結果

### 正常な動作
- 全ロールでログイン後、適切な画面にリダイレクト
- 全機能が正常に動作
- エラーメッセージが適切に表示
- データの整合性が保たれる

### 注意点
- テスト中にエラーが発生した場合は、データベースを再初期化
- ブラウザのキャッシュをクリアしてからテスト実行
- 各テストケースは独立して実行可能

---

## トラブルシューティング

### よくある問題
1. **ログインできない**: データベースの初期化を実行
2. **データが表示されない**: シーダーの実行を確認
3. **ページネーションエラー**: カスタムページネーションビューの確認
4. **権限エラー**: ユーザーロールの確認

### 解決方法
```bash
# データベース再初期化
php artisan migrate:fresh --seed --class=InternshipTestSeeder

# キャッシュクリア
php artisan optimize:clear

# アプリケーション再起動
php artisan serve
```
